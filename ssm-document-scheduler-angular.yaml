---
schemaVersion: "2.2"
description: |
  ### Nome documento  - OQ6-REAGENDAMENTO-DEPLOY

  ## O que esse documento faz? 
  Atualizada o horário de execução dos eventos (EventBridge) que executa o deploy do OQ6 no S3.

  ## Parâmetros de entrada
  * Implantacao: Fase da implantação que será reagendada (green ou blue)
  * Dia: Dia no formato GMT
  * Mês: Mês no formato GMT
  * Ano: Ano no formato GMT
  * Hora: Hora no formato GMT
  * Minutos: Minuto no formato GMT

parameters:
  Implantacao:
    type: "String"
    description: "Fase da implantação que será reagendada. 'blue' corresponde a equalização (De 'green' para 'blue'), o 'green' corresponde ao primeiro deploy"
    allowedValues:
    - blue
    - green
  Dia:
    type: "String"
    description: "Dia no formato GMT. LEMBRAR DE ADICIONAR 3 HORAS NA DATA"
    allowedValues:
    - "Selecione"    
    - "1"
    - "2"
    - "3"
    - "4"
    - "5"
    - "6"
    - "7"
    - "8"
    - "9"
    - "10"
    - "11"
    - "12"
    - "13"
    - "14"
    - "15"
    - "16"
    - "17"
    - "18"
    - "19"
    - "20"
    - "21"
    - "22"
    - "23"
    - "24"
    - "25"
    - "26"
    - "27"
    - "28"
    - "29"
    - "30"
    - "31"
  Mes:
    type: "String"
    description: "Mês no formato GMT. LEMBRAR DE ADICIONAR 3 HORAS NA DATA"
    allowedValues:
    - "Selecione"       
    - "1"
    - "2"
    - "3"
    - "4"  
    - "5"
    - "6"
    - "7"
    - "8"
    - "9"
    - "10"
    - "11"
    - "12"  
  Ano:
    type: "String"
    description: "Ano no formato GMT. LEMBRAR DE ADICIONAR 3 HORAS NA DATA"
    allowedValues:
    - "Selecione"     
    - "2022"
    - "2023"
    - "2024"
    - "2025"      
  Hora:
    type: "String"
    description: "Hora no formato GMT. LEMBRAR DE ADICIONAR 3 HORAS NA DATA"
    allowedValues:       
    - "Selecione"      
    - "0"
    - "1"
    - "2"
    - "3"
    - "4"
    - "5"
    - "6"
    - "7"
    - "8"
    - "9"
    - "10"
    - "11"
    - "12"
    - "13"
    - "14"
    - "15"
    - "16"
    - "17"
    - "18"
    - "19"
    - "20"
    - "21"
    - "22"
    - "23"
  Minutos:
    type: "String"
    description: "Minutos no formato GMT. LEMBRAR DE ADICIONAR 3 HORAS NA DATA"
    allowedValues:  
    - "Selecione"    
    - "0"
    - "5"
    - "10"
    - "15"
    - "20"
    - "25"
    - "30"   
    - "35"   
    - "40"   
    - "45"
    - "55"
mainSteps:
  - action: "aws:runShellScript"
    name: "SchedulerDeploy"
    precondition:
      StringEquals:
      - platformType
      - Linux    
    inputs:
      runCommand:
      - |
        #!/bin/bash

        echo "- Inicio do script de reagendamento"
        
        deployment="{{Implantacao}}"
        hours={{Hora}}
        minutes={{Minutos}}
        dayOfMonth={{Dia}}
        month={{Mes}}
        dayOfWeek=?
        year={{Ano}}

        filter="-bg-"

        if echo "$deployment" | grep -i -w "blue"
        then
            filter="?contains(Name, \`-bg-\`) == \`true\`"
        else
            filter="?ends_with(Name, \`Prod\`) == \`true\`"
        fi

        echo "- Horario de reagendamento para 'cron(${minutes} ${hours} ${dayOfMonth} ${month} ${dayOfWeek} ${year})'"

        echo "- Consulta eventos: Artefatos: Angular - Implantação: ${deployment} - Critério: '${filter}'"

        aws events list-rules --query "Rules[?Name!=\`null\`]|[${filter}].[Name,Description]" --output text  \
        | awk '{print $1 "|" $2}' \
        | while read ruleNameAndDescription;
        do     
                ruleName=$(echo "$ruleNameAndDescription" | awk -F'|' '{print $1}' 2>&1)
                description=$(echo "$ruleNameAndDescription" | awk -F'|' '{print $2}' 2>&1)
 
                echo "# ${ruleName}/${description} : Reagendamento para 'cron(${minutes} ${hours} ${dayOfMonth} ${month} ${dayOfWeek} ${year})'"
                # aws cli bug, necessario envio da descricao para nao ficar em branco apos atualizacao
                aws events put-rule --name ${ruleName} --description $description --schedule-expression "cron(${minutes} ${hours} ${dayOfMonth} ${month} ${dayOfWeek} ${year})"
        done

        echo "- Fim do script de reagendamento"